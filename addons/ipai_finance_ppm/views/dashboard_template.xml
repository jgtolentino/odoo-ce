<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="dashboard_template" name="Finance PPM Dashboard">
        <t t-call="web.layout">
            <t t-set="head">
                <!-- ECharts CDN -->
                <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
                <style>
                    .finance-ppm-dashboard {
                        padding: 20px;
                        background-color: #f5f7fa;
                    }
                    .dashboard-header {
                        margin-bottom: 30px;
                    }
                    .dashboard-title {
                        font-size: 28px;
                        font-weight: bold;
                        color: #2c3e50;
                        margin-bottom: 10px;
                    }
                    .dashboard-subtitle {
                        font-size: 14px;
                        color: #7f8c8d;
                    }
                    .kpi-cards {
                        display: flex;
                        gap: 20px;
                        margin-bottom: 30px;
                        flex-wrap: wrap;
                    }
                    .kpi-card {
                        flex: 1;
                        min-width: 200px;
                        background: white;
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .kpi-card h3 {
                        font-size: 32px;
                        font-weight: bold;
                        margin: 0 0 8px 0;
                        color: #2c3e50;
                    }
                    .kpi-card p {
                        margin: 0;
                        font-size: 14px;
                        color: #7f8c8d;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .kpi-card.green h3 { color: #27ae60; }
                    .kpi-card.orange h3 { color: #f39c12; }
                    .kpi-card.red h3 { color: #e74c3c; }
                    .chart-container {
                        background: white;
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .chart-title {
                        font-size: 18px;
                        font-weight: bold;
                        color: #2c3e50;
                        margin-bottom: 15px;
                    }
                    .chart {
                        width: 100%;
                        height: 400px;
                    }
                    .charts-row {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                </style>
            </t>

            <div class="finance-ppm-dashboard">
                <!-- Header -->
                <div class="dashboard-header">
                    <div class="dashboard-title">TBWA Finance PPM Dashboard</div>
                    <div class="dashboard-subtitle">
                        BIR Filing Schedule · Logframe Tracking · Critical Path Analysis
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <h3><t t-esc="kpi_total"/></h3>
                        <p>Total BIR Forms</p>
                    </div>
                    <div class="kpi-card green">
                        <h3><t t-esc="kpi_ontime"/></h3>
                        <p>On-Time Filings</p>
                    </div>
                    <div class="kpi-card green">
                        <h3><t t-esc="kpi_compliance_rate"/>%</h3>
                        <p>Compliance Rate</p>
                    </div>
                    <div class="kpi-card orange">
                        <h3><t t-esc="kpi_atrisk"/></h3>
                        <p>At Risk</p>
                    </div>
                    <div class="kpi-card red">
                        <h3><t t-esc="kpi_late"/></h3>
                        <p>Late Filings</p>
                    </div>
                </div>

                <!-- BIR Deadline Timeline Chart -->
                <div class="chart-container">
                    <div class="chart-title">BIR Deadline Timeline</div>
                    <div id="bir-timeline-chart" class="chart"></div>
                </div>

                <!-- Charts Row (2 columns) -->
                <div class="charts-row">
                    <!-- Completion Tracking Chart -->
                    <div class="chart-container">
                        <div class="chart-title">Completion Tracking</div>
                        <div id="completion-chart" class="chart"></div>
                    </div>

                    <!-- Status Distribution Chart -->
                    <div class="chart-container">
                        <div class="chart-title">Status Distribution</div>
                        <div id="status-pie-chart" class="chart"></div>
                    </div>
                </div>

                <!-- Logframe Overview Chart -->
                <div class="chart-container">
                    <div class="chart-title">Logframe Overview</div>
                    <div id="logframe-chart" class="chart"></div>
                </div>
            </div>

            <!-- JavaScript: Initialize ECharts -->
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function() {
                    // Parse data from controller
                    var birCategories = <t t-esc="bir_categories"/>;
                    var birTimelineData = <t t-esc="bir_timeline_data"/>;
                    var completionData = <t t-esc="completion_data"/>;
                    var statusPieData = <t t-esc="status_pie_data"/>;
                    var logframeData = <t t-esc="logframe_data"/>;

                    // 1. BIR Deadline Timeline (Bar Chart)
                    var birTimelineChart = echarts.init(document.getElementById('bir-timeline-chart'));
                    var birTimelineOption = {
                        title: {
                            text: 'Days Until Deadline',
                            left: 'left',
                            textStyle: { fontSize: 14, color: '#7f8c8d' }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: birCategories,
                            axisLabel: { rotate: 45, interval: 0 }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Days'
                        },
                        series: [{
                            name: 'Days Until Deadline',
                            type: 'bar',
                            data: birTimelineData,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.data.label ? params.data.label.formatter : '';
                                }
                            }
                        }]
                    };
                    birTimelineChart.setOption(birTimelineOption);

                    // 2. Completion Tracking (Horizontal Bar Chart)
                    var completionChart = echarts.init(document.getElementById('completion-chart'));
                    var completionOption = {
                        title: {
                            text: 'Completion Percentage',
                            left: 'left',
                            textStyle: { fontSize: 14, color: '#7f8c8d' }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: function(params) {
                                return params[0].name + ': ' + params[0].value + '%';
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'value',
                            max: 100,
                            axisLabel: { formatter: '{value}%' }
                        },
                        yAxis: {
                            type: 'category',
                            data: completionData.map(function(d) { return d.name; })
                        },
                        series: [{
                            name: 'Completion',
                            type: 'bar',
                            data: completionData,
                            label: {
                                show: true,
                                position: 'right',
                                formatter: '{c}%'
                            }
                        }]
                    };
                    completionChart.setOption(completionOption);

                    // 3. Status Distribution (Pie Chart)
                    var statusPieChart = echarts.init(document.getElementById('status-pie-chart'));
                    var statusPieOption = {
                        title: {
                            text: 'BIR Form Status',
                            left: 'left',
                            textStyle: { fontSize: 14, color: '#7f8c8d' }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            right: 10,
                            top: 'center'
                        },
                        series: [{
                            name: 'Status',
                            type: 'pie',
                            radius: '50%',
                            data: statusPieData,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    statusPieChart.setOption(statusPieOption);

                    // 4. Logframe Overview (Bar Chart)
                    var logframeChart = echarts.init(document.getElementById('logframe-chart'));
                    var logframeOption = {
                        title: {
                            text: 'Task Count by Logframe Level',
                            left: 'left',
                            textStyle: { fontSize: 14, color: '#7f8c8d' }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: logframeData.map(function(d) { return d.level; })
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Task Count'
                        },
                        series: [{
                            name: 'Tasks',
                            type: 'bar',
                            data: logframeData.map(function(d) { return d.count; }),
                            itemStyle: {
                                color: '#3498db'
                            },
                            label: {
                                show: true,
                                position: 'top'
                            }
                        }]
                    };
                    logframeChart.setOption(logframeOption);

                    // Make charts responsive
                    window.addEventListener('resize', function() {
                        birTimelineChart.resize();
                        completionChart.resize();
                        statusPieChart.resize();
                        logframeChart.resize();
                    });
                });
            </script>
        </t>
    </template>
</odoo>
