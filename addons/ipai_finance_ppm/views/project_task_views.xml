<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend standard project task form with Finance PPM fields -->
    <record id="view_task_form_finance_inherit" model="ir.ui.view">
        <field name="name">project.task.form.finance.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <!-- Add Finance Roles tab with Clarity PPM hierarchy -->
            <xpath expr="//page[@name='specification']" position="after">
                <page string="Finance PPM" name="finance_ppm_tab">
                    <group>
                        <group string="Clarity PPM Hierarchy">
                            <field name="finance_phase_id"/>
                            <field name="finance_milestone"/>
                            <field name="finance_milestone_type" invisible="not finance_milestone"/>
                            <field name="finance_todo_progress" widget="progressbar"/>
                        </group>
                        <group string="Finance Assignment">
                            <field name="finance_code"/>
                            <field name="finance_person_id"/>
                            <field name="finance_category"/>
                        </group>
                    </group>
                    <group>
                        <group string="Approval Workflow">
                            <field name="reviewer_id"/>
                            <field name="approver_id"/>
                            <field name="finance_deadline_type"/>
                        </group>
                        <group string="Duration Planning">
                            <field name="prep_duration"/>
                            <field name="review_duration"/>
                            <field name="approval_duration"/>
                        </group>
                    </group>
                    <!-- To-Do Checklist (Clarity PPM concept) -->
                    <separator string="To-Do Checklist"/>
                    <field name="finance_todo_ids">
                        <list editable="bottom">
                            <field name="sequence" widget="handle"/>
                            <field name="name"/>
                            <field name="assignee_id"/>
                            <field name="due_date"/>
                            <field name="is_done" widget="boolean_toggle"/>
                            <field name="done_date" readonly="1"/>
                        </list>
                    </field>
                </page>
            </xpath>
            
            <!-- Add finance code to main form -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="finance_code" class="oe_inline"/>
            </xpath>
            
            <!-- Add Finance PPM fields to existing tabs -->
            <xpath expr="//group[@name='sale_order']" position="after">
                <group string="Finance PPM" name="finance_ppm">
                    <field name="finance_logframe_id"/>
                    <field name="bir_schedule_id"/>
                    <field name="is_finance_ppm" readonly="1"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Extend project task tree view -->
    <record id="view_task_tree_finance_inherit" model="ir.ui.view">
        <field name="name">project.task.tree.finance.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_tree2"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="finance_code"/>
                <field name="finance_person_id"/>
            </xpath>
        </field>
    </record>

    <!-- Create Finance PPM specific action for project tasks -->
    <record id="action_finance_ppm_tasks" model="ir.actions.act_window">
        <field name="name">Finance PPM Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,form,kanban,calendar,timeline</field>
        <field name="domain">[('is_finance_ppm', '=', True)]</field>
        <field name="context">{
            'search_default_my_tasks': 1,
            'default_is_finance_ppm': True
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first finance PPM task!
            </p>
        </field>
    </record>

    <!-- Add Finance PPM filter to project tasks -->
    <record id="view_task_search_finance_inherit" model="ir.ui.view">
        <field name="name">project.task.search.finance.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_search_form"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='my_tasks']" position="after">
                <filter name="finance_ppm_tasks" string="Finance PPM Tasks" domain="[('is_finance_ppm', '=', True)]"/>
                <separator/>
                <filter name="finance_category" string="Finance Category" context="{'group_by': 'finance_category'}"/>
                <filter name="finance_person" string="Finance Person" context="{'group_by': 'finance_person_id'}"/>
            </xpath>
        </field>
    </record>
</odoo>
