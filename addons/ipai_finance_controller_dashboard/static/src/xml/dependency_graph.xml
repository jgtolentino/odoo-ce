<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="ipai_finance_controller_dashboard.dependency_graph">
        <!-- Dependency Graph: Task prerequisite network -->
        <div class="viz-card viz-full">
            <h3 class="viz-card-title">Dependency Graph - Task Prerequisite Network</h3>
            <div id="chart-dependency-graph" class="chart-container-large"></div>
        </div>

        <script type="text/javascript">
            (function() {
                function loadDependencyGraph(employeeCode) {
                    fetch('/ipai/finance/controller/api/dependency_graph', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'call',
                            params: { employee_code: employeeCode || 'RIM' }
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        const graphData = data.result;
                        renderDependencyGraph(graphData);
                    })
                    .catch(error => console.error('Error loading dependency graph:', error));
                }

                function renderDependencyGraph(graphData) {
                    const chart = echarts.init(document.getElementById('chart-dependency-graph'));

                    // Get unique categories for legend
                    const categories = [...new Set(graphData.nodes.map(n => n.category))];
                    const categoryData = categories.map(cat => ({ name: cat }));

                    // Assign category index to nodes
                    const nodesWithCategory = graphData.nodes.map(node => ({
                        id: node.id,
                        name: node.name,
                        category: categories.indexOf(node.category),
                        symbolSize: 30,
                        label: {
                            show: true,
                            fontSize: 10
                        }
                    }));

                    chart.setOption({
                        title: {
                            text: 'Task Dependency Network (Parent-Child)',
                            left: 'center',
                            textStyle: { fontSize: 18, fontWeight: 'bold' }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: function(params) {
                                if (params.dataType === 'node') {
                                    return params.name;
                                } else if (params.dataType === 'edge') {
                                    return params.data.source + ' â†’ ' + params.data.target;
                                }
                            }
                        },
                        legend: [{
                            data: categoryData.map(c => c.name),
                            orient: 'vertical',
                            left: 'left',
                            top: 60
                        }],
                        series: [
                            {
                                type: 'graph',
                                layout: 'force',
                                data: nodesWithCategory,
                                links: graphData.links,
                                categories: categoryData,
                                roam: true,
                                draggable: true,
                                label: {
                                    position: 'right',
                                    formatter: '{b}'
                                },
                                labelLayout: {
                                    hideOverlap: true
                                },
                                scaleLimit: {
                                    min: 0.4,
                                    max: 2
                                },
                                lineStyle: {
                                    color: 'source',
                                    curveness: 0.3,
                                    width: 2
                                },
                                emphasis: {
                                    focus: 'adjacency',
                                    lineStyle: {
                                        width: 4
                                    }
                                },
                                force: {
                                    repulsion: 500,
                                    gravity: 0.1,
                                    edgeLength: [100, 200],
                                    layoutAnimation: true
                                }
                            }
                        ]
                    });

                    window.addEventListener('resize', () => chart.resize());
                }

                document.addEventListener('DOMContentLoaded', function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const employeeCode = urlParams.get('employee_code') || 'RIM';
                    loadDependencyGraph(employeeCode);
                });
            })();
        </script>
    </t>
</templates>
