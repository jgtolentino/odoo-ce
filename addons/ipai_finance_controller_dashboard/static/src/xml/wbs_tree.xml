<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="ipai_finance_controller_dashboard.wbs_tree">
        <!-- WBS Tree: Collapsible task hierarchy -->
        <div class="viz-card viz-half">
            <h3 class="viz-card-title">WBS Hierarchy Tree - Task Structure</h3>
            <div id="chart-wbs-tree" class="chart-container-large"></div>
        </div>

        <script type="text/javascript">
            (function() {
                function loadWBSTree(employeeCode) {
                    fetch('/ipai/finance/controller/api/wbs_tree', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'call',
                            params: { employee_code: employeeCode || 'RIM' }
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        const treeData = data.result;
                        renderWBSTree(treeData);
                    })
                    .catch(error => console.error('Error loading WBS tree:', error));
                }

                function renderWBSTree(treeData) {
                    const chart = echarts.init(document.getElementById('chart-wbs-tree'));

                    chart.setOption({
                        title: {
                            text: 'Month-End Close Task Hierarchy',
                            left: 'center',
                            textStyle: { fontSize: 16, fontWeight: 'bold' }
                        },
                        tooltip: {
                            trigger: 'item',
                            triggerOn: 'mousemove',
                            formatter: function(params) {
                                return params.name;
                            }
                        },
                        series: [
                            {
                                type: 'tree',
                                data: [treeData],
                                top: '10%',
                                left: '8%',
                                bottom: '5%',
                                right: '20%',
                                symbolSize: 10,
                                label: {
                                    position: 'left',
                                    verticalAlign: 'middle',
                                    align: 'right',
                                    fontSize: 11,
                                    color: '#333'
                                },
                                leaves: {
                                    label: {
                                        position: 'right',
                                        verticalAlign: 'middle',
                                        align: 'left'
                                    }
                                },
                                emphasis: {
                                    focus: 'descendant'
                                },
                                expandAndCollapse: true,
                                animationDuration: 550,
                                animationDurationUpdate: 750,
                                initialTreeDepth: 2,
                                lineStyle: {
                                    color: '#ccc',
                                    width: 1.5,
                                    curveness: 0.5
                                },
                                itemStyle: {
                                    color: function(params) {
                                        return params.data.itemStyle &amp;&amp; params.data.itemStyle.color
                                            ? params.data.itemStyle.color
                                            : '#5470C6';
                                    },
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }
                            }
                        ]
                    });

                    window.addEventListener('resize', () => chart.resize());
                }

                document.addEventListener('DOMContentLoaded', function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const employeeCode = urlParams.get('employee_code') || 'RIM';
                    loadWBSTree(employeeCode);
                });
            })();
        </script>
    </t>
</templates>
