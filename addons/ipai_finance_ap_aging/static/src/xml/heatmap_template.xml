<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
<t t-name="ipai_finance_ap_aging.heatmap_template">
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>AP Aging Heatmap - <t t-esc="employee_code"/></title>
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f8f9fa; padding: 20px; }
            .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
            h1 { color: #2c3e50; margin-bottom: 10px; font-size: 28px; }
            .subtitle { color: #7f8c8d; margin-bottom: 30px; font-size: 14px; }
            .kpi-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
            .kpi-card { flex: 1; min-width: 200px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; }
            .kpi-card.overdue { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
            .kpi-card.vendors { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
            .kpi-value { font-size: 36px; font-weight: bold; margin-bottom: 5px; }
            .kpi-label { font-size: 14px; opacity: 0.9; }
            #ap-aging-heatmap { width: 100%; height: 600px; margin-bottom: 30px; }
            .btn-container { display: flex; gap: 15px; }
            .btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
            .btn-primary { background: #667eea; color: white; }
            .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
            .btn-secondary { background: #ecf0f1; color: #2c3e50; }
            .btn-secondary:hover { background: #d5dbdb; }
            .icon { width: 16px; height: 16px; }
            @media print {
                .btn-container { display: none; }
                body { background: white; }
                .container { box-shadow: none; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üìä AP Aging Heatmap - <t t-esc="employee_code"/></h1>
            <div class="subtitle">Month-End Close Review | Snapshot Date: <t t-esc="snapshot_date"/></div>

            <!-- KPI Cards -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-total-payables">‚Ç±0</div>
                    <div class="kpi-label">Total Outstanding Payables</div>
                </div>
                <div class="kpi-card vendors">
                    <div class="kpi-value" id="kpi-vendor-count">0</div>
                    <div class="kpi-label">Active Vendors</div>
                </div>
                <div class="kpi-card overdue">
                    <div class="kpi-value" id="kpi-overdue">‚Ç±0</div>
                    <div class="kpi-label">Overdue (90+ days)</div>
                </div>
            </div>

            <!-- Heatmap Chart -->
            <div id="ap-aging-heatmap"></div>

            <!-- Action Buttons -->
            <div class="btn-container">
                <button id="btn-print-report" class="btn btn-primary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Print Report
                </button>
                <button id="btn-export-excel" class="btn btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export to Excel
                </button>
            </div>
        </div>

        <script>
            // Parse aging data from Odoo
            const agingData = <t t-raw="aging_data"/>;

            // Update KPI Cards with formatted values
            const formatCurrency = (amount) => {
                return '‚Ç±' + parseFloat(amount).toLocaleString('en-PH', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            };

            document.getElementById('kpi-total-payables').textContent = formatCurrency(agingData.total_payables);
            document.getElementById('kpi-vendor-count').textContent = agingData.vendor_count;
            document.getElementById('kpi-overdue').textContent = formatCurrency(agingData.total_overdue_90plus);

            // Prepare heatmap data
            const vendorNames = agingData.vendors.map(v => v.vendor_name);
            const buckets = ['0-30 days', '31-60 days', '61-90 days', '90+ days'];
            const heatmapData = [];

            agingData.vendors.forEach((vendor, vendorIdx) => {
                heatmapData.push([0, vendorIdx, parseFloat(vendor.bucket_0_30 || 0)]);
                heatmapData.push([1, vendorIdx, parseFloat(vendor.bucket_31_60 || 0)]);
                heatmapData.push([2, vendorIdx, parseFloat(vendor.bucket_61_90 || 0)]);
                heatmapData.push([3, vendorIdx, parseFloat(vendor.bucket_90_plus || 0)]);
            });

            // Calculate max value for color scale
            const maxValue = Math.max(...heatmapData.map(d => d[2]), 1);

            // Initialize ECharts Heatmap
            const chart = echarts.init(document.getElementById('ap-aging-heatmap'));
            const option = {
                title: {
                    text: 'Vendor Payment Aging Analysis',
                    subtext: 'Color intensity indicates payment amount in each aging bucket',
                    left: 'center',
                    textStyle: { fontSize: 20, fontWeight: 'bold', color: '#2c3e50' },
                    subtextStyle: { fontSize: 12, color: '#7f8c8d' }
                },
                tooltip: {
                    position: 'top',
                    formatter: function(params) {
                        const vendorName = vendorNames[params.data[1]];
                        const bucket = buckets[params.data[0]];
                        const amount = formatCurrency(params.data[2]);
                        return `<strong>${vendorName}</strong><br/>${bucket}: ${amount}`;
                    }
                },
                grid: {
                    height: '60%',
                    top: '20%',
                    left: '25%',
                    right: '10%'
                },
                xAxis: {
                    type: 'category',
                    data: buckets,
                    splitArea: { show: true },
                    axisLabel: { fontSize: 11, fontWeight: 'bold', color: '#2c3e50' }
                },
                yAxis: {
                    type: 'category',
                    data: vendorNames,
                    splitArea: { show: true },
                    axisLabel: { fontSize: 10, color: '#2c3e50', width: 150, overflow: 'truncate', ellipsis: '...' }
                },
                visualMap: {
                    min: 0,
                    max: maxValue,
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '2%',
                    inRange: {
                        color: ['#e8f5e9', '#a5d6a7', '#66bb6a', '#43a047', '#2e7d32', '#1b5e20']
                    },
                    text: ['High', 'Low'],
                    textStyle: { color: '#2c3e50', fontSize: 11 }
                },
                series: [{
                    name: 'AP Amount',
                    type: 'heatmap',
                    data: heatmapData,
                    label: {
                        show: true,
                        formatter: function(params) {
                            const amount = params.data[2];
                            if (amount === 0) return '';
                            if (amount >= 1000000) return '‚Ç±' + (amount / 1000000).toFixed(1) + 'M';
                            if (amount >= 1000) return '‚Ç±' + (amount / 1000).toFixed(0) + 'K';
                            return '‚Ç±' + amount.toFixed(0);
                        },
                        fontSize: 10,
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)',
                            borderWidth: 2,
                            borderColor: '#fff'
                        }
                    }
                }]
            };

            chart.setOption(option);

            // Responsive resize
            window.addEventListener('resize', () => chart.resize());

            // Print Report Button
            document.getElementById('btn-print-report').addEventListener('click', () => {
                window.print();
            });

            // Export to Excel Button
            document.getElementById('btn-export-excel').addEventListener('click', () => {
                // Prepare CSV data
                let csvContent = 'Vendor Name,VAT,0-30 days,31-60 days,61-90 days,90+ days,Total Outstanding,Invoice Count\n';
                agingData.vendors.forEach(vendor => {
                    csvContent += `"${vendor.vendor_name}","${vendor.vendor_vat || ''}",`;
                    csvContent += `${vendor.bucket_0_30},${vendor.bucket_31_60},${vendor.bucket_61_90},${vendor.bucket_90_plus},`;
                    csvContent += `${vendor.total_outstanding},${vendor.invoice_count}\n`;
                });

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ap_aging_${agingData.employee_code}_${agingData.snapshot_date}.csv`;
                link.click();
            });
        </script>
    </body>
    </html>
</t>

<!-- Error Template -->
<t t-name="ipai_finance_ap_aging.error_template">
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <title>Error - AP Aging</title>
        <style>
            body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f8f9fa; }
            .error-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; max-width: 500px; }
            .error-icon { font-size: 64px; margin-bottom: 20px; }
            .error-message { color: #e74c3c; font-size: 18px; margin-bottom: 20px; }
        </style>
    </head>
    <body>
        <div class="error-box">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-message"><t t-esc="error_message"/></div>
            <button onclick="history.back()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">Go Back</button>
        </div>
    </body>
    </html>
</t>
</templates>
