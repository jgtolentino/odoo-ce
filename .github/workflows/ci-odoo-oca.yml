name: Odoo 18 CE / OCA CI

on:
  push:
    branches: [ main, "18.0", "18.0-*", "claude/*" ]
  pull_request:
    branches: [ main, "18.0", "18.0-*" ]

permissions:
  contents: read
  pull-requests: write

env:
  ODOO_VERSION: "18.0"
  PYTHON_VERSION: "3.10"
  DB_NAME: "odoo"
  DAGGER_CACHE: "false"

jobs:
  lint:
    name: Lint & Static Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install base tooling
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black isort pylint flake8
          # Optional OCA tools if you use them:
          # pip install oca-maintainer-tools

      - name: Run pre-commit
        run: |
          if [ -f .pre-commit-config.yaml ]; then
            pre-commit run --all-files
          else
            echo "No pre-commit config; skipping."
          fi

      - name: Enterprise contamination check
        run: |
          set -e
          echo "Scanning for Odoo Enterprise/IAP dependencies..."

          # Check for Enterprise imports in Python files
          enterprise_imports=$(grep -Rn "from odoo\.addons\..*_enterprise" addons oca 2>/dev/null || true)
          enterprise_imports="$enterprise_imports$(grep -Rn "import odoo\.addons\..*_enterprise" addons oca 2>/dev/null || true)"

          # Check for Enterprise modules in manifest dependencies
          enterprise_depends=$(grep -A5 '"depends"' addons/*/__manifest__.py oca/*/__manifest__.py 2>/dev/null | grep -i "enterprise\|web_studio\|documents\|iap" || true)

          # Check for common Enterprise keywords
          enterprise_keywords=$(grep -Rn --include="*.py" "web_studio\|documents_\|iap_" addons oca 2>/dev/null || true)

          if [ -n "$enterprise_imports" ] || [ -n "$enterprise_depends" ] || [ -n "$enterprise_keywords" ]; then
            echo "::error::Possible Odoo Enterprise/IAP dependency detected."
            echo "Enterprise imports:"
            echo "$enterprise_imports"
            echo "Enterprise depends:"
            echo "$enterprise_depends"
            echo "Enterprise keywords:"
            echo "$enterprise_keywords"
            echo ""
            echo "Remove these references or move them to a separate, non-CE repo."
            exit 1
          fi
          echo "✅ No Enterprise/IAP dependencies found."

      - name: odoo.com URL check
        run: |
          set -e
          echo "Scanning for odoo.com URLs in code..."

          odoo_urls=$(grep -Rn --include="*.py" --include="*.xml" 'href=.*odoo\.com\|url.*=.*odoo\.com\|https\?://.*\.odoo\.com' addons oca 2>/dev/null || true)

          if [ -n "$odoo_urls" ]; then
            echo "::warning::Found odoo.com URLs in code – consider replacing with InsightPulse/OCA links."
            echo "$odoo_urls"
          else
            echo "✅ No odoo.com URLs found."
          fi

      - name: Python syntax check
        run: |
          echo "Checking Python syntax..."
          python -m compileall addons oca 2>/dev/null || echo "Some modules failed syntax check"

  tests:
    name: ${{ matrix.test-suite.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: "Unit Tests"
            tags: "/unit"
            description: "Fast unit tests"
          - name: "Integration Tests"
            tags: "/integration"
            description: "Database integration tests"
          - name: "All Tests"
            tags: ""
            description: "Complete test suite"
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports: ["5432:5432"]

    env:
      # DB connection for Odoo
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: odoo
      PGPASSWORD: odoo
      PGDATABASE: odoo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Odoo and dependencies
        run: |
          python -m pip install --upgrade pip

          # Install system dependencies for Odoo
          sudo apt-get update
          sudo apt-get install -y \
            libpq-dev \
            libsasl2-dev \
            libldap2-dev \
            libssl-dev \
            libxml2-dev \
            libxslt1-dev \
            libjpeg-dev \
            libfreetype6-dev \
            liblcms2-dev \
            libwebp-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libxcb1-dev

          # Clone Odoo 18.0 from official repository
          git clone --depth 1 --branch 18.0 https://github.com/odoo/odoo.git /tmp/odoo

          # Install Odoo Python dependencies
          pip install -r /tmp/odoo/requirements.txt

          # Install testing and coverage tools
          pip install coverage pytest-cov

          # Install custom module requirements if exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: List addons
        run: |
          echo "Custom addons:"
          ls -1 addons || true
          echo ""
          echo "OCA addons:"
          ls -1 oca || true

      - name: Run Odoo tests for custom modules
        run: |
          # Get list of installable modules from addons/
          MODULES=$(find addons -name "__manifest__.py" -exec dirname {} \; | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')

          if [ -z "$MODULES" ]; then
            echo "No modules found to test"
            exit 0
          fi

          echo "========================================="
          echo "Test Suite: ${{ matrix.test-suite.description }}"
          echo "Test Tags: ${{ matrix.test-suite.tags }}"
          echo "Testing modules: $MODULES"
          echo "========================================="

          # Prepare test command
          TEST_CMD="python /tmp/odoo/odoo-bin -d $DB_NAME -i $MODULES --stop-after-init --log-level=test --test-enable --addons-path=/tmp/odoo/addons,addons,oca"

          # Add test tags if specified
          if [ -n "${{ matrix.test-suite.tags }}" ]; then
            TEST_CMD="$TEST_CMD --test-tags=${{ matrix.test-suite.tags }}"
          fi

          # Run tests with coverage if this is the full test suite
          if [ "${{ matrix.test-suite.name }}" == "All Tests" ]; then
            echo "Running with coverage analysis..."
            coverage run --source=addons --omit='*/tests/*' /tmp/odoo/odoo-bin \
              -d "$DB_NAME" \
              -i "$MODULES" \
              --stop-after-init \
              --log-level=test \
              --test-enable \
              --addons-path=/tmp/odoo/addons,addons,oca

            # Generate coverage report
            echo ""
            echo "========================================="
            echo "Coverage Report"
            echo "========================================="
            coverage report -m
            coverage html -d coverage_html
          else
            # Run tests without coverage for faster execution
            eval $TEST_CMD
          fi

      - name: Upload coverage report
        if: matrix.test-suite.name == 'All Tests'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage_html/
          retention-days: 30

      - name: Comment coverage on PR
        if: matrix.test-suite.name == 'All Tests' && github.event_name == 'pull_request'
        run: |
          COVERAGE_PCT=$(coverage report | tail -1 | awk '{print $NF}')
          echo "Test coverage: $COVERAGE_PCT"
          # Coverage percentage can be used in PR comments if needed

  openupgrade-smoke:
    name: OpenUpgrade Smoke (optional)
    if: github.ref == 'refs/heads/18.0'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install OpenUpgrade tools
        run: |
          python -m pip install --upgrade pip
          pip install openupgradelib

      - name: Check migration scripts
        run: |
          if [ -d openupgrade_scripts ]; then
            echo "Found openupgrade_scripts; running import check..."
            python -m compileall openupgrade_scripts
          else
            echo "No openupgrade_scripts directory; skipping."
          fi

  performance:
    name: Performance Tests
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports: ["5432:5432"]

    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: odoo
      PGPASSWORD: odoo
      PGDATABASE: odoo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y libpq-dev

          # Clone Odoo
          git clone --depth 1 --branch 18.0 https://github.com/odoo/odoo.git /tmp/odoo
          pip install -r /tmp/odoo/requirements.txt

          # Install performance testing tools
          pip install locust psutil memory_profiler

      - name: Module installation performance test
        run: |
          echo "========================================="
          echo "Performance Test: Module Installation"
          echo "========================================="

          MODULES=$(find addons -name "__manifest__.py" -exec dirname {} \; | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')

          if [ -z "$MODULES" ]; then
            echo "No modules found to test"
            exit 0
          fi

          # Time the installation
          START_TIME=$(date +%s)

          python /tmp/odoo/odoo-bin \
            -d "$DB_NAME" \
            -i "$MODULES" \
            --stop-after-init \
            --log-level=warn \
            --addons-path=/tmp/odoo/addons,addons,oca

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo ""
          echo "========================================="
          echo "Performance Results"
          echo "========================================="
          echo "Module installation took: ${DURATION} seconds"
          echo "Modules tested: $MODULES"

          # Warn if installation takes too long
          if [ $DURATION -gt 300 ]; then
            echo "::warning::Module installation took longer than 5 minutes (${DURATION}s)"
          fi

      - name: Database size check
        run: |
          echo "========================================="
          echo "Database Size Analysis"
          echo "========================================="

          psql -h localhost -U odoo -d odoo -c "
            SELECT
              pg_size_pretty(pg_database_size('odoo')) as database_size,
              pg_size_pretty(pg_total_relation_size('ir_model')) as ir_model_size;
          "

  repo-structure:
    name: Repository Structure Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tree command
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Regenerate repo tree
        run: |
          if [ -f scripts/gen_repo_tree.sh ]; then
            ./scripts/gen_repo_tree.sh
          else
            echo "No gen_repo_tree.sh script found; skipping."
          fi

      - name: Check if repo tree is up to date
        run: |
          if [ -f spec.md ]; then
            if ! git diff --quiet spec.md; then
              echo "::warning::Repo tree in spec.md is out of date. Run ./scripts/gen_repo_tree.sh and commit."
              echo "Expected diff:"
              git diff spec.md
            else
              echo "✅ Repo tree is up to date"
            fi
          else
            echo "No spec.md found; skipping tree check."
          fi
