name: Odoo SaaS Parity Tests

on:
  pull_request:
    paths:
      - "addons/ipai_equipment/**"
      - "addons/ipai_expense/**"
      - "addons/ipai_cash_advance/**"
      - "addons/ipai_ocr_expense/**"
      - "addons/ipai_docs/**"
      - "addons/ipai_docs_project/**"
      - "agents/**"
      - "docs/FEATURE_*.md"
      - "docs/SAAS_PARITY_READINESS.md"
  push:
    branches:
      - main
      - feature/add-expense-equipment-prd

jobs:
  test-parity:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: odoo
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpq-dev \
            libxml2-dev \
            libxslt1-dev \
            libldap2-dev \
            libsasl2-dev \
            libjpeg-dev \
            zlib1g-dev

      - name: Install Python dependencies
        env:
          PIP_CONSTRAINT: scripts/ci/constraints-gevent.txt
        run: |
          pip install --upgrade pip

          # Apply CI-only constraints to avoid gevent/Cython build issues
          pip install -c "$PIP_CONSTRAINT" "Cython<3" "greenlet<3" "gevent==22.10.2"

          if [ -f requirements.txt ]; then
            pip install -c "$PIP_CONSTRAINT" -r requirements.txt
          else
            echo "requirements.txt not found, installing odoo dependencies"
          fi

          pip install -c "$PIP_CONSTRAINT" psycopg2-binary wheel

      - name: Install Odoo 18 CE from source
        run: |
          scripts/ci/install_odoo_18.sh

      - name: Wait for PostgreSQL
        run: |
          python - << 'PY'
          import sys
          import time

          import psycopg2


          host = "localhost"
          port = 5432
          user = "odoo"
          dbname = "postgres"

          max_tries = 30
          for attempt in range(1, max_tries + 1):
            try:
              conn = psycopg2.connect(
                host=host,
                port=port,
                user=user,
                dbname=dbname,
              )
              conn.close()
              print(f"PostgreSQL is ready after {attempt} attempts.")
              sys.exit(0)
            except Exception as exc:  # noqa: PERF203
              print(f"[{attempt}/{max_tries}] Waiting for PostgreSQL... {exc}")
              time.sleep(2)

          print("PostgreSQL did not become ready in time.")
          sys.exit(1)
          PY

      - name: Run module migrations
        run: |
          # Note: migrations would run here if modules were already installed
          echo "Skipping migrations (fresh database)"

      - name: Run Cheqroom parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_cheqroom
        run: |
          echo "Testing Cheqroom parity (ipai_equipment)..."
          bash ./odoo-bin -d test_cheqroom \
            -i ipai_equipment \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Cheqroom parity tests FAILED"
              exit 1
            }
          echo "✅ Cheqroom parity tests PASSED"

      - name: Run Concur parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_concur
        run: |
          echo "Testing Concur parity (ipai_expense)..."
          bash ./odoo-bin -d test_concur \
            -i ipai_expense \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Concur parity tests FAILED"
              exit 1
            }
          echo "✅ Concur parity tests PASSED"

      - name: Run Workspace parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_workspace
        run: |
          echo "Testing Workspace parity (ipai_docs)..."
          bash ./odoo-bin -d test_workspace \
            -i ipai_docs \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Workspace parity tests FAILED"
              exit 1
            }
          echo "✅ Workspace parity tests PASSED"

      - name: Parity Test Summary
        if: always()
        run: |
          echo "==================================================="
          echo "SaaS Parity Test Summary"
          echo "==================================================="
          echo "Cheqroom (ipai_equipment): ${{ job.status }}"
          echo "Concur (ipai_expense): ${{ job.status }}"
          echo "Workspace (ipai_docs): ${{ job.status }}"
          echo "==================================================="
          echo "See docs/SAAS_PARITY_READINESS.md for validation details"

      - name: Report CI telemetry
        if: always()
        env:
          N8N_CI_WEBHOOK_URL: ${{ secrets.N8N_CI_WEBHOOK_URL }}
        run: |
          bash scripts/report_ci_telemetry.sh "${{ job.status }}"
        shell: bash
