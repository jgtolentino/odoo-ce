name: Odoo SaaS Parity Tests

on:
  push:
    branches:
      - main
      - "18.0"
      - "18.0-*"
      - "feature/**"
      - "fix/**"
      - "release/**"
  pull_request:
    branches:
      - main
      - "18.0"
      - "18.0-*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-parity:
    name: Run Odoo parity tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: postgres
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 5432:5432

    env:
      PGHOST: localhost
      PGPORT: "5432"
      PGUSER: odoo
      PGPASSWORD: odoo
      PGDATABASE: postgres

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libpq-dev \
            libsasl2-dev \
            libldap2-dev \
            libssl-dev \
            libxml2-dev \
            libxslt1-dev \
            zlib1g-dev \
            libjpeg-dev \
            libfreetype6-dev \
            liblcms2-dev \
            libwebp-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libxcb1-dev

      - name: Install Odoo and Python dependencies
        run: |
          python -m pip install --upgrade pip

          # Clone Odoo 18.0 for runtime dependencies
          git clone --depth 1 --branch 18.0 https://github.com/odoo/odoo.git /tmp/odoo

          # Install Odoo dependencies
          pip install -r /tmp/odoo/requirements.txt
          pip install psycopg2-binary

      - name: Wait for PostgreSQL
        shell: python
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
        run: |
          import time
          import psycopg2
          import sys
          import os

          host = os.environ['PGHOST']
          port = os.environ['PGPORT']
          user = os.environ['PGUSER']
          password = os.environ['PGPASSWORD']
          dbname = 'postgres'

          print(f"Waiting for PostgreSQL at {host}:{port}...")

          for i in range(30):
            try:
              conn = psycopg2.connect(
                host=host,
                port=port,
                user=user,
                password=password,
                dbname=dbname,
              )
              conn.close()
              print("PostgreSQL is ready!")
              sys.exit(0)
            except psycopg2.OperationalError:
              time.sleep(1)
            except Exception as e:
              print(f"Connection failed: {e}")
              time.sleep(1)

          print("PostgreSQL did not become ready in time.")
          sys.exit(1)

      - name: Run module migrations
        run: |
          echo "Skipping migrations (fresh database)"

      - name: Run Cheqroom parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_cheqroom
        run: |
          echo "Testing Cheqroom parity (ipai_equipment)..."
          # Using python3 directly to avoid 'bash: command not found'
          python3 ./odoo-bin -d test_cheqroom \
            -i ipai_equipment \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Cheqroom parity tests FAILED"
              exit 1
            }
          echo "✅ Cheqroom parity tests PASSED"

      - name: Run Concur parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_concur
        run: |
          echo "Testing Concur parity (ipai_expense)..."
          python3 ./odoo-bin -d test_concur \
            -i ipai_expense \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Concur parity tests FAILED"
              exit 1
            }
          echo "✅ Concur parity tests PASSED"

      - name: Report CI telemetry
        if: always()
        run: |
          # Using sh to avoid 'bash: command not found'
          sh scripts/report_ci_telemetry.sh "${{ job.status }}"
