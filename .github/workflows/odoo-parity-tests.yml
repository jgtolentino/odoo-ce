- name: Wait for PostgreSQL
        shell: python
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
        run: |
          import time
          import psycopg2
          import sys
          import os

          host = os.environ['PGHOST']
          port = os.environ['PGPORT']
          user = os.environ['PGUSER']
          password = os.environ['PGPASSWORD']
          dbname = 'postgres'

          print(f"Waiting for PostgreSQL at {host}:{port}...")

          for i in range(30):
              try:
                  conn = psycopg2.connect(
                      host=host,
                      port=port,
                      user=user,
                      password=password, # <--- CRITICAL FIX APPLIED HERE
                      dbname=dbname,
                  )
                  conn.close()
                  print("PostgreSQL is ready!")
                  sys.exit(0)
              except psycopg2.OperationalError:
                  time.sleep(1)
              except Exception as e:
                  print(f"Connection failed: {e}")
                  time.sleep(1)

          print("PostgreSQL did not become ready in time.")
          sys.exit(1)

      - name: Run module migrations
        run: |
          echo "Skipping migrations (fresh database)"

      - name: Run Cheqroom parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_cheqroom
        run: |
          echo "Testing Cheqroom parity (ipai_equipment)..."
          # Using python3 directly to avoid 'bash: command not found'
          python3 ./odoo-bin -d test_cheqroom \
            -i ipai_equipment \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Cheqroom parity tests FAILED"
              exit 1
            }
          echo "✅ Cheqroom parity tests PASSED"

      - name: Run Concur parity tests
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: test_concur
        run: |
          echo "Testing Concur parity (ipai_expense)..."
          python3 ./odoo-bin -d test_concur \
            -i ipai_expense \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo || {
              echo "❌ Concur parity tests FAILED"
              exit 1
            }
          echo "✅ Concur parity tests PASSED"

      - name: Report CI telemetry
        if: always()
        run: |
          # Using sh to avoid 'bash: command not found'
          sh scripts/report_ci_telemetry.sh "${{ job.status }}"