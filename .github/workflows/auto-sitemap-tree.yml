# =============================================================================
# Auto-Update Sitemap & Tree on Every Commit
# =============================================================================
# This workflow automatically regenerates:
# - SITEMAP.md (navigable documentation map)
# - TREE.md (repository structure)
# 
# Triggers: Every push to main/develop branches
# =============================================================================

name: Auto-Update Sitemap & Tree

on:
  push:
    branches: [main, develop, feature/*]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate stats
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate TREE.md
        run: |
          cat > TREE.md << 'HEADER'
          # ðŸ“ Repository Structure
          
          > Auto-generated on every commit. Last update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          > Commit: ${{ github.sha }}
          
          ```
          HEADER
          
          # Generate tree, excluding common noise
          tree -a -I '.git|node_modules|__pycache__|*.pyc|.DS_Store|.env|*.egg-info|dist|build|.mypy_cache|.pytest_cache|.coverage|htmlcov|*.lock' --dirsfirst -L 4 >> TREE.md
          
          echo '```' >> TREE.md
          
          # Add stats
          cat >> TREE.md << 'STATS'
          
          ## ðŸ“Š Stats
          
          | Metric | Count |
          |--------|-------|
          STATS
          
          echo "| Directories | $(find . -type d -not -path './.git/*' | wc -l) |" >> TREE.md
          echo "| Files | $(find . -type f -not -path './.git/*' | wc -l) |" >> TREE.md
          echo "| Python files | $(find . -name '*.py' -not -path './.git/*' | wc -l) |" >> TREE.md
          echo "| XML files | $(find . -name '*.xml' -not -path './.git/*' | wc -l) |" >> TREE.md
          echo "| Markdown files | $(find . -name '*.md' -not -path './.git/*' | wc -l) |" >> TREE.md

      - name: Generate SITEMAP.md
        run: |
          cat > SITEMAP.md << 'EOF'
          # ðŸ—ºï¸ Sitemap - InsightPulse ERP
          
          > Auto-generated on every commit. Last update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          > Commit: ${{ github.sha }}
          
          ## ðŸ“š Documentation
          
          | Document | Description |
          |----------|-------------|
          EOF
          
          # Find all markdown files and add to sitemap
          find . -name "*.md" -not -path "./.git/*" | sort | while read file; do
            # Get first heading or filename
            title=$(grep -m1 "^#" "$file" 2>/dev/null | sed 's/^#* //' || basename "$file" .md)
            # Clean path
            path="${file#./}"
            echo "| [$title]($path) | $(dirname $path) |" >> SITEMAP.md
          done
          
          cat >> SITEMAP.md << 'EOF'
          
          ## ðŸ“¦ Modules (ipai_*)
          
          | Module | Status | Description |
          |--------|--------|-------------|
          EOF
          
          # Find all ipai modules
          find . -type d -name "ipai_*" | sort | while read dir; do
            name=$(basename "$dir")
            manifest="$dir/__manifest__.py"
            if [ -f "$manifest" ]; then
              # Extract summary from manifest
              summary=$(grep -o "'summary':\s*['\"].*['\"]" "$manifest" 2>/dev/null | head -1 | sed "s/'summary':\s*['\"]//;s/['\"]$//" || echo "No description")
              echo "| [$name]($dir) | âœ… | $summary |" >> SITEMAP.md
            else
              echo "| [$name]($dir) | âš ï¸ | Missing manifest |" >> SITEMAP.md
            fi
          done
          
          cat >> SITEMAP.md << 'EOF'
          
          ## ðŸ”§ Configuration Files
          
          | File | Purpose |
          |------|---------|
          EOF
          
          # Key config files
          [ -f "docker-compose.yml" ] && echo "| [docker-compose.yml](docker-compose.yml) | Docker orchestration |" >> SITEMAP.md
          [ -f "docker-compose.prod.yml" ] && echo "| [docker-compose.prod.yml](docker-compose.prod.yml) | Production Docker |" >> SITEMAP.md
          [ -f "Dockerfile" ] && echo "| [Dockerfile](Dockerfile) | Container build |" >> SITEMAP.md
          [ -f "odoo.conf" ] && echo "| [odoo.conf](odoo.conf) | Odoo configuration |" >> SITEMAP.md
          [ -f "config/odoo.conf" ] && echo "| [config/odoo.conf](config/odoo.conf) | Odoo configuration |" >> SITEMAP.md
          [ -f "requirements.txt" ] && echo "| [requirements.txt](requirements.txt) | Python dependencies |" >> SITEMAP.md
          [ -f ".github/workflows/ci.yml" ] && echo "| [.github/workflows/ci.yml](.github/workflows/ci.yml) | CI/CD pipeline |" >> SITEMAP.md
          
          cat >> SITEMAP.md << 'EOF'
          
          ## ðŸ”— Quick Links
          
          - **Production**: https://erp.insightpulseai.net
          - **Repository**: https://github.com/jgtolentino/odoo-ce
          - **OCA Modules**: https://github.com/OCA
          
          ---
          
          *This sitemap auto-updates on every commit via GitHub Actions.*
          EOF

      - name: Install tree (if needed)
        run: |
          if ! command -v tree &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y tree
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet SITEMAP.md TREE.md 2>/dev/null; then
            echo "No changes to commit"
          else
            git add SITEMAP.md TREE.md
            git commit -m "docs: auto-update SITEMAP.md and TREE.md [skip ci]" || true
            git push || true
          fi
