# Odoo CE v0.9.1 - Quick Deployment Guide

**Audit Status:** ‚ö†Ô∏è v0.9.0 has 3 critical issues ‚Üí **Deploy v0.9.1 instead**

## Executive Summary

**Current Image:** `ghcr.io/jgtolentino/odoo-ce:v0.9.0` ‚ùå **NOT PRODUCTION-READY**  
**Fixed Image:** `ghcr.io/jgtolentino/odoo-ce:v0.9.1` ‚úÖ **PRODUCTION-READY**

**Critical Fixes in v0.9.1:**
1. ‚úÖ Python requirements auto-installation
2. ‚úÖ Environment variable defaults (HOST, PORT, USER, PASSWORD, DB)
3. ‚úÖ Health check configuration for Docker/Kubernetes

**Estimated Time:** 4-6 hours (including VPS upgrade)

---

## Prerequisites

**Infrastructure:**
- VPS: `odoo-erp-prod` at `159.223.75.148` (currently 4GB RAM)
- DNS: `erp.insightpulseai.net` ‚Üí 159.223.75.148 (A record)
- SSL: Let's Encrypt (CAA record configured)

**Access Required:**
- SSH access to VPS (root@159.223.75.148)
- GitHub Container Registry push access (GHCR_PAT)
- DigitalOcean admin access (for VPS resize)

**Files Needed:**
- `Dockerfile.v0.9.1` (provided in audit outputs)
- `docker-compose.prod.yml` (update image tag to v0.9.1)
- `.env.production` (with real DB passwords)

---

## Deployment Steps

### Step 1: VPS Upgrade (1 hour)

**Why:** Current 4GB RAM insufficient for Odoo + Auth + n8n. Upgrading to 8GB prevents OOM (out-of-memory) issues.

**Option A: Via DigitalOcean Console**
1. Go to: https://cloud.digitalocean.com/droplets
2. Select: `odoo-erp-prod`
3. Click: **Resize** ‚Üí Select **8GB RAM / 4vCPU** ($48/month)
4. Click: **Resize Droplet**
5. Wait 5-10 minutes for resize to complete

**Option B: Via CLI (doctl)**
```bash
# Install doctl if not present
snap install doctl

# Authenticate
doctl auth init

# Resize droplet
doctl compute droplet resize odoo-erp-prod --size s-4vcpu-8gb --wait

# Verify
doctl compute droplet get odoo-erp-prod --format Name,Memory
# Expected: Memory = 8192 MB
```

**Verification:**
```bash
ssh root@159.223.75.148 free -h
# Expected output:
#               total        used        free
# Mem:           7.8Gi       2.1Gi       4.2Gi
```

**Cost Impact:** +$24/month ($24 ‚Üí $48)

---

### Step 2: Build & Push v0.9.1 Image (1 hour)

**On your local machine or CI runner:**

```bash
# Clone/navigate to odoo-ce repo
cd ~/odoo-ce  # Or wherever your repo is

# Replace Dockerfile with fixed version
cp /path/to/Dockerfile.v0.9.1 ./Dockerfile

# Set image tag
export IMAGE=ghcr.io/jgtolentino/odoo-ce:v0.9.1

# Login to GitHub Container Registry
echo "$GHCR_PAT" | docker login ghcr.io -u jgtolentino --password-stdin

# Build image with BuildKit (faster, better caching)
DOCKER_BUILDKIT=1 docker build -t "$IMAGE" .

# Verify build succeeded
docker images | grep odoo-ce
# Expected: ghcr.io/jgtolentino/odoo-ce  v0.9.1  [IMAGE_ID]  [SIZE]

# Push to registry
docker push "$IMAGE"

# Verify push
echo "‚úÖ Image available at: https://github.com/jgtolentino/odoo-ce/pkgs/container/odoo-ce"
```

**Troubleshooting:**
- **Build fails:** Check Dockerfile syntax, ensure `./addons` and `./deploy` exist
- **Push fails:** Verify GHCR_PAT has `write:packages` permission
- **Large image size:** Expected ~1.3-1.5GB (base odoo:18.0 is ~1.2GB)

---

### Step 3: Update docker-compose.prod.yml (15 minutes)

**On VPS (159.223.75.148):**

```bash
ssh root@159.223.75.148

# Navigate to deployment directory
cd ~/odoo-prod  # Or wherever your docker-compose.prod.yml is

# Backup current config
cp docker-compose.prod.yml docker-compose.prod.yml.backup

# Update image tag (replace v0.9.0 with v0.9.1)
sed -i 's|ghcr.io/jgtolentino/odoo-ce:.*|ghcr.io/jgtolentino/odoo-ce:v0.9.1|g' docker-compose.prod.yml

# Verify change
grep "image:" docker-compose.prod.yml
# Expected: image: ghcr.io/jgtolentino/odoo-ce:v0.9.1

# OPTIONAL: Add log volume (recommended for troubleshooting)
cat >> docker-compose.prod.yml << 'EOF'

# Add under 'volumes:' section at bottom of file:
  odoo-logs:
EOF

# Then add to odoo service volumes:
# - odoo-logs:/var/log/odoo
```

**Sample docker-compose.prod.yml (key sections):**
```yaml
version: '3.8'

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: odoo
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # From .env.production
    volumes:
      - odoo-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U odoo"]
      interval: 10s
      timeout: 5s
      retries: 5

  odoo:
    image: ghcr.io/jgtolentino/odoo-ce:v0.9.1  # ‚Üê UPDATED
    container_name: odoo-ce
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      HOST: db
      USER: odoo
      PASSWORD: ${DB_PASSWORD}
      ODOO_RC: /etc/odoo/odoo.conf
    volumes:
      - ./deploy/odoo.conf:/etc/odoo/odoo.conf:ro
      - ./addons:/mnt/extra-addons
      - ./oca:/mnt/oca-addons
      - odoo-filestore:/var/lib/odoo
      - odoo-logs:/var/log/odoo  # ‚Üê NEW (optional)
    ports:
      - "127.0.0.1:8069:8069"

volumes:
  odoo-db-data:
  odoo-filestore:
  odoo-logs:  # ‚Üê NEW (optional)
```

---

### Step 4: Deploy v0.9.1 (30 minutes)

**On VPS (159.223.75.148):**

```bash
cd ~/odoo-prod

# Verify .env.production exists with real passwords
cat .env.production
# Expected: DB_PASSWORD=<real_password> (not CHANGE_ME_*)

# Pull new image
docker compose pull odoo

# Stop current Odoo (keeps database running)
docker compose stop odoo

# Remove old container
docker compose rm -f odoo

# Start new container
docker compose up -d odoo

# Verify startup
docker compose logs -f odoo --tail 50
# Watch for:
# ‚úÖ "HTTP service (werkzeug) running on 0.0.0.0:8069"
# ‚úÖ No critical errors
# ‚ùå If you see "CHANGE_ME_*" warnings, stop and fix .env.production
```

**Expected Logs (healthy deployment):**
```
odoo-ce  | odoo.service.server: HTTP service (werkzeug) running on 0.0.0.0:8069
odoo-ce  | odoo.modules.loading: Modules loaded.
odoo-ce  | odoo.addons.base.models.ir_http: Generating routing map for key 1
```

---

### Step 5: Health Check & Verification (30 minutes)

**Run smoke test script:**

```bash
# On VPS
cd ~/odoo-prod

# Create smoke test script
cat > scripts/smoketest.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "üîç Odoo CE v0.9.1 Production Smoke Test"
echo "========================================"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# Test 1: Container Running
echo -n "1. Container running... "
if docker ps | grep -q "odoo-ce"; then
    echo -e "${GREEN}‚úÖ PASS${NC}"
else
    echo -e "${RED}‚ùå FAIL${NC}"; exit 1
fi

# Test 2: Health Check
echo -n "2. Health endpoint... "
if curl -sf http://127.0.0.1:8069/web/health > /dev/null; then
    echo -e "${GREEN}‚úÖ PASS${NC}"
else
    echo -e "${RED}‚ùå FAIL${NC}"; exit 1
fi

# Test 3: Database Connection
echo -n "3. Database connection... "
if docker compose exec -T db pg_isready -U odoo > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ PASS${NC}"
else
    echo -e "${RED}‚ùå FAIL${NC}"; exit 1
fi

# Test 4: Custom Modules
echo -n "4. Custom modules... "
MODULE_COUNT=$(docker compose exec -T odoo ls -1 /mnt/extra-addons | grep -c "ipai_" || true)
if [ "$MODULE_COUNT" -eq 5 ]; then
    echo -e "${GREEN}‚úÖ PASS (5 modules)${NC}"
else
    echo -e "${RED}‚ùå FAIL (expected 5, found $MODULE_COUNT)${NC}"; exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All checks passed - System operational${NC}"
EOF

chmod +x scripts/smoketest.sh

# Run smoke test
bash scripts/smoketest.sh
```

**Manual Verification:**

```bash
# 1. Check container status
docker compose ps
# Expected: odoo-ce STATUS = Up (healthy)

# 2. Check resource usage
docker stats --no-stream odoo-ce
# Expected: MEM USAGE < 2GB, CPU < 50%

# 3. Test web interface
curl -I https://erp.insightpulseai.net/web
# Expected: HTTP/2 200 or 302

# 4. Check logs for errors
docker compose logs odoo --tail 100 | grep -i "error\|critical\|exception"
# Expected: No critical errors (warnings OK)

# 5. Test database connectivity
docker compose exec odoo odoo-bin shell -c "import psycopg2; print('‚úÖ DB OK')"
# Expected: ‚úÖ DB OK
```

---

### Step 6: Browser Testing (15 minutes)

**Open in browser:**

1. Navigate to: https://erp.insightpulseai.net
2. Expected: Odoo login page (not error)
3. Login with admin credentials
4. Go to: **Apps** ‚Üí Search "ipai"
5. Verify all 5 custom modules visible:
   - ‚úÖ IPAI CE Cleaner
   - ‚úÖ IPAI Equipment Management
   - ‚úÖ IPAI Expense & Travel (PH)
   - ‚úÖ IPAI Finance Monthly Closing
   - ‚úÖ IPAI Expense OCR

**If modules not visible:**
```bash
# Force module list update
docker compose exec odoo odoo-bin -c /etc/odoo/odoo.conf \
  -d odoo \
  --update all \
  --stop-after-init
```

---

## Rollback Procedure (If Needed)

**If v0.9.1 deployment fails:**

```bash
cd ~/odoo-prod

# Stop failed deployment
docker compose down

# Restore backup config
cp docker-compose.prod.yml.backup docker-compose.prod.yml

# Restart with v0.9.0 (or last known good version)
docker compose up -d

# Verify
docker compose ps
curl -I http://127.0.0.1:8069/web
```

**Post-rollback:**
1. Review logs: `docker compose logs odoo --tail 200`
2. Document failure reason
3. Open GitHub issue with logs
4. Contact: Jake Tolentino for escalation

---

## Monitoring & Alerts

### Set Up DigitalOcean Alerts

**Via CLI:**
```bash
# High memory alert (>85%)
doctl monitoring alert-policy create \
  --name "odoo-high-memory" \
  --type v1/insights/droplet/memory_utilization_percent \
  --compare GreaterThan \
  --value 85 \
  --window 5m \
  --emails "your-email@example.com"

# High CPU alert (>90%)
doctl monitoring alert-policy create \
  --name "odoo-high-cpu" \
  --type v1/insights/droplet/cpu \
  --compare GreaterThan \
  --value 90 \
  --window 5m \
  --emails "your-email@example.com"
```

**Via Console:**
1. Go to: https://cloud.digitalocean.com/monitoring
2. Click: **Create Alert Policy**
3. Select: `odoo-erp-prod` droplet
4. Add alerts for: Memory (>85%), CPU (>90%), Disk (>80%)

---

## Post-Deployment Checklist

- [ ] VPS upgraded to 8GB RAM
- [ ] v0.9.1 image built and pushed to GHCR
- [ ] docker-compose.prod.yml updated
- [ ] Deployment successful (smoke test passed)
- [ ] Browser test successful (login works)
- [ ] Custom modules visible in Apps
- [ ] Monitoring alerts configured
- [ ] Backup strategy verified (database backups)
- [ ] Documentation updated (deployment log)

---

## Troubleshooting

### Issue: Container keeps restarting

**Symptoms:**
```bash
docker compose ps
# STATUS: Restarting (1) 5 seconds ago
```

**Fix:**
```bash
# Check logs
docker compose logs odoo --tail 100

# Common causes:
# 1. Database password mismatch ‚Üí Fix .env.production
# 2. Port 8069 already in use ‚Üí Stop conflicting service
# 3. Out of memory ‚Üí Verify VPS upgrade to 8GB
```

### Issue: Health check fails

**Symptoms:**
```bash
curl http://127.0.0.1:8069/web/health
# Connection refused or 503
```

**Fix:**
```bash
# Wait for startup (takes 60 seconds)
sleep 60 && curl http://127.0.0.1:8069/web/health

# If still failing, check logs
docker compose logs odoo | grep -i "werkzeug\|http"
```

### Issue: Custom modules not loading

**Symptoms:**
- Modules not visible in Apps
- Import errors in logs

**Fix:**
```bash
# Verify modules are in container
docker compose exec odoo ls -la /mnt/extra-addons

# Force module update
docker compose exec odoo odoo-bin -c /etc/odoo/odoo.conf \
  -d odoo \
  -u ipai_expense,ipai_ocr_expense,ipai_finance_monthly_closing \
  --stop-after-init

# Restart Odoo
docker compose restart odoo
```

---

## Success Metrics

**After deployment, you should see:**

1. **Container Health:** `docker compose ps` shows `STATUS: Up (healthy)`
2. **Resource Usage:** `docker stats odoo-ce` shows MEM < 2GB, CPU < 50%
3. **Web Access:** https://erp.insightpulseai.net loads without errors
4. **Custom Modules:** All 5 ipai_* modules visible in Apps
5. **No Critical Errors:** `docker compose logs odoo` has no CRITICAL/FATAL entries
6. **Response Time:** Health endpoint responds in < 1 second

---

## Next Steps

**After successful v0.9.1 deployment:**

1. **Monitor for 24 hours:** Watch logs, resource usage, user reports
2. **Schedule backup verification:** Test database restore procedure
3. **Document lessons learned:** Update runbook with any issues encountered
4. **Plan DOKS migration:** Evaluate Kubernetes for better scalability
5. **Cost optimization:** Consider migrating n8n to App Platform (-$12/month savings)

---

## Support & Escalation

**Primary Contact:**
- **Owner:** Jake Tolentino
- **GitHub:** https://github.com/jgtolentino/odoo-ce
- **Issues:** Open GitHub issue with `deployment` label

**Critical Production Issues:**
- Tag: @jgtolentino in GitHub issue
- Email: jgtolentino@tbwa-smp.ph
- Escalate to: Finance Director CKVC (Khalil Veracruz)

**Infrastructure Access:**
- **VPS SSH:** root@159.223.75.148 (key required)
- **GHCR:** ghcr.io/jgtolentino/odoo-ce
- **DigitalOcean:** Project dashboard access needed

---

**END OF DEPLOYMENT GUIDE**

**Good luck with the deployment! üöÄ**
